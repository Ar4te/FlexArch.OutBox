name: Pull Request æ£€æŸ¥

on:
  pull_request:
    branches: [master, develop]

env:
  DOTNET_VERSION: "8.0.x"
  SOLUTION_PATH: "./FlexArch.OutBox.sln"
  COVERAGE_THRESHOLD: "0.70"

jobs:
  pr-validation:
    name: PR éªŒè¯
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”½ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ æ¢å¤ä¾èµ–é¡¹
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: ğŸ“ ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic || {
            echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼Œè¯·è¿è¡Œ 'dotnet format' ä¿®å¤åå†æäº¤ã€‚"
            exit 1
          }

      - name: ğŸ§± æ„å»ºæ£€æŸ¥ï¼ˆå«è­¦å‘Šï¼‰
        run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release -p:TreatWarningsAsErrors=true

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: dotnet test ${{ env.SOLUTION_PATH }} --no-build --configuration Release --logger "console;verbosity=detailed"

      - name: ğŸ“Š é‡‡é›†æµ‹è¯•è¦†ç›–ç‡
        run: dotnet test ${{ env.SOLUTION_PATH }} --no-build --configuration Release --collect:"XPlat Code Coverage" --results-directory ./coverage

      - name: ğŸ“¦ ä¸Šä¼ è¦†ç›–ç‡ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage
          path: ./coverage

      - name: âœ… è¦†ç›–ç‡é˜ˆå€¼æ£€æŸ¥
        run: |
          FILE=$(find ./coverage -name 'coverage.cobertura.xml' | head -n 1)
          if [ -f "$FILE" ]; then
            RATE=$(grep -oP 'line-rate="\K[0-9.]+' "$FILE")
            echo "ğŸ“ˆ æ£€æµ‹åˆ°è¦†ç›–ç‡: $RATE"
            if (( $(echo "$RATE < $COVERAGE_THRESHOLD" | bc -l) )); then
              echo "âŒ è¦†ç›–ç‡ä½äºæœ€ä½é˜ˆå€¼ $COVERAGE_THRESHOLD"
              exit 1
            else
              echo "âœ… è¦†ç›–ç‡è¾¾æ ‡"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è¦†ç›–ç‡æŠ¥å‘Šæ–‡ä»¶"
            exit 1
          fi

      # å¦‚æœä½ å¯ç”¨äº† Codecov.ioï¼Œå¯å¯ç”¨æ­¤æ­¥éª¤
      # - name: â˜ï¸ ä¸Šä¼ åˆ° Codecovï¼ˆå¯é€‰ï¼‰
      #   uses: codecov/codecov-action@v3
      #   with:
      #     directory: ./coverage
      #     flags: pull-request
      #     name: pr-check

      - name: âœ… PR æ£€æŸ¥å®Œæˆ
        run: |
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ŒPR å¯ä»¥åˆå¹¶ã€‚"
          echo "ğŸ“ ä»£ç æ ¼å¼: é€šè¿‡"
          echo "ğŸ“¦ æ„å»ºçŠ¶æ€: æˆåŠŸ"
          echo "ğŸ§ª æµ‹è¯•çŠ¶æ€: æˆåŠŸ"
          echo "ğŸ“ˆ è¦†ç›–ç‡æ£€æŸ¥: é€šè¿‡"
