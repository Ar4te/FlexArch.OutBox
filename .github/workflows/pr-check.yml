name: Pull Request æ£€æŸ¥

on:
  pull_request:
    branches: [main, develop]

env:
  DOTNET_VERSION: "8.0.x"

jobs:
  pr-validation:
    name: PR éªŒè¯
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: æ¢å¤ä¾èµ–é¡¹
        run: dotnet restore

      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic
          if [ $? -ne 0 ]; then
            echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼è¯·è¿è¡Œ 'dotnet format' æ¥ä¿®å¤æ ¼å¼é—®é¢˜ã€‚"
            exit 1
          fi

      - name: æ„å»ºæ£€æŸ¥
        run: |
          dotnet build --no-restore --configuration Release -p:TreatWarningsAsErrors=true
          if [ $? -ne 0 ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼è¯·ä¿®å¤ç¼–è¯‘é”™è¯¯å’Œè­¦å‘Šã€‚"
            exit 1
          fi

      - name: è¿è¡Œæµ‹è¯•
        run: |
          dotnet test --no-build --configuration Release --logger "console;verbosity=detailed"
          if [ $? -ne 0 ]; then
            echo "âŒ æµ‹è¯•å¤±è´¥ï¼è¯·ä¿®å¤å¤±è´¥çš„æµ‹è¯•ã€‚"
            exit 1
          fi

      - name: æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
        run: |
          dotnet test --collect:"XPlat Code Coverage" --results-directory ./coverage
          # è¿™é‡Œå¯ä»¥æ·»åŠ è¦†ç›–ç‡é˜ˆå€¼æ£€æŸ¥

      - name: PR æ£€æŸ¥å®Œæˆ
        run: |
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼PR å¯ä»¥åˆå¹¶ã€‚"
          echo "ğŸ“Š æ„å»ºçŠ¶æ€: é€šè¿‡"
          echo "ğŸ§ª æµ‹è¯•çŠ¶æ€: é€šè¿‡" 
          echo "ğŸ“ æ ¼å¼æ£€æŸ¥: é€šè¿‡"
