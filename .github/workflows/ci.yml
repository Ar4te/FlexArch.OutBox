name: CI/CD Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

env:
  DOTNET_VERSION: "8.0.x"
  SOLUTION_PATH: "./FlexArch.OutBox.sln"

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: æ¢å¤ä¾èµ–é¡¹
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic || {
            echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼Œè¯·è¿è¡Œ 'dotnet format' ä¿®å¤æ ¼å¼é—®é¢˜ã€‚"
            exit 1
          }

      - name: æ„å»ºæ£€æŸ¥
        run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release

  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - run: dotnet restore ${{ env.SOLUTION_PATH }}

      - run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration ${{ matrix.configuration }}

      - name: è¿è¡Œæµ‹è¯•
        run: |
          dotnet test ${{ env.SOLUTION_PATH }} \
            --no-build \
            --configuration ${{ matrix.configuration }} \
            --logger trx \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.configuration }}
          path: ./TestResults

      - name: å‘å¸ƒä»£ç è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.configuration == 'Release'
        uses: codecov/codecov-action@v3
        with:
          directory: ./TestResults
          flags: unittests
          name: codecov-umbrella

      - name: æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡é˜ˆå€¼
        if: matrix.configuration == 'Release'
        run: |
          FILE=$(find ./TestResults -name 'coverage.cobertura.xml' | head -n 1)
          if [ -f "$FILE" ]; then
            RATE=$(grep -oP 'line-rate="\K[0-9.]+' "$FILE")
            THRESHOLD=0.70
            echo "ğŸ“ˆ è¦†ç›–ç‡: $RATE"
            if (( $(echo "$RATE < $THRESHOLD" | bc -l) )); then
              echo "âŒ è¦†ç›–ç‡ä½äºé˜ˆå€¼ $THRESHOLD"
              exit 1
            else
              echo "âœ… è¦†ç›–ç‡è¾¾æ ‡"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è¦†ç›–ç‡æŠ¥å‘Š"
            exit 1
          fi

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: å®‰å…¨æ¼æ´æ‰«æ
        run: |
          dotnet list package --vulnerable --include-transitive | tee vulnerable-packages.log
          if grep -E "Severity\s+:|Transitive Package\s+" vulnerable-packages.log > /dev/null; then
            echo "âŒ å‘ç°å®‰å…¨æ¼æ´ï¼è¯·æŸ¥çœ‹ vulnerable-packages.logã€‚"
            exit 1
          else
            echo "âœ… æœªå‘ç°å®‰å…¨æ¼æ´ã€‚"
          fi

      - name: è¿‡æ—¶åŒ…æ£€æŸ¥
        run: |
          dotnet list package --outdated --include-transitive | tee outdated-packages.log
          echo "ğŸ“¦ è¿‡æ—¶åŒ…ä¿¡æ¯æ£€æŸ¥å®Œæˆã€‚"

      - name: ä¸Šä¼ å®‰å…¨æ‰«ææ—¥å¿—
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            vulnerable-packages.log
            outdated-packages.log

  # åŒ…æ„å»ºå’Œå‘å¸ƒ
  package:
    name: æ„å»º NuGet åŒ…
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test, security-scan]
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - run: dotnet restore ${{ env.SOLUTION_PATH }}

      - run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release

      - name: åˆ›å»º NuGet åŒ…
        run: |
          mkdir -p ./packages
          dotnet pack ./FlexArch.OutBox.Abstractions/FlexArch.OutBox.Abstractions.csproj --no-build --configuration Release --output ./packages
          dotnet pack ./FlexArch.OutBox.Core/FlexArch.OutBox.Core.csproj --no-build --configuration Release --output ./packages
          dotnet pack ./FlexArch.OutBox.Persistence.EFCore/FlexArch.OutBox.Persistence.EFCore.csproj --no-build --configuration Release --output ./packages
          dotnet pack ./FlexArch.OutBox.Publisher.RabbitMQ/FlexArch.OutBox.Publisher.RabbitMQ.csproj --no-build --configuration Release --output ./packages

      - uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./packages/*.nupkg

      # - name: å‘å¸ƒåˆ° NuGetï¼ˆå¯é€‰ï¼‰
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   run: |
      #     dotnet nuget push ./packages/*.nupkg \
      #       --api-key ${{ secrets.NUGET_API_KEY }} \
      #       --source https://api.nuget.org/v3/index.json \
      #       --skip-duplicate

  # æ€§èƒ½æµ‹è¯•ï¼ˆå ä½ï¼‰
  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: dotnet restore ${{ env.SOLUTION_PATH }}
      - run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release
      - run: |
          echo "ğŸ“ˆ æ€§èƒ½æµ‹è¯•å ä½ï¼šå¯é›†æˆ NBomber æˆ– BenchmarkDotNet"

  # é€šçŸ¥ï¼ˆå¯æ‹“å±• Slackã€é£ä¹¦ã€Teamsï¼‰
  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test, security-scan]
    if: always()
    steps:
      - name: å·¥ä½œæµçŠ¶æ€æŠ¥å‘Š
        run: |
          if [[ "${{ needs.code-quality.result }}" == "failure" || "${{ needs.build-and-test.result }}" == "failure" || "${{ needs.security-scan.result }}" == "failure" ]]; then
            echo "âŒ å·¥ä½œæµå¤±è´¥"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"
          fi
